---
import BaseLayout from "../layouts/BaseLayout.astro";
import PageHeader from "../components/PageHeader.astro";
import { getCollection, getEntry } from "astro:content";

const runsPage = await getEntry("pages", "runs");

if (!runsPage) {
  throw new Error("Missing content entry: src/content/pages/runs.md");
}

const { title, description, headerTitle, headerSubtitle } = runsPage.data;

const runSections = (await getCollection("runs")).sort(
  (a, b) => a.data.order - b.data.order
);

const runCards = await Promise.all(
  runSections
    .filter((entry) => entry.data.sectionType === "run")
    .map(async (entry) => {
      const { Content } = await entry.render();
      return {
        id: entry.slug,
        data: entry.data,
        Content,
        hasBody: (entry.body ?? "").trim().length > 0,
      };
    })
);

const ctaEntry = runSections.find((entry) => entry.data.sectionType === "cta");
const ctaSection = ctaEntry
  ? {
      data: ctaEntry.data,
      ...(await ctaEntry.render()),
      hasBody: (ctaEntry.body ?? "").trim().length > 0,
    }
  : null;
---
<BaseLayout title={title} description={description}>
  <PageHeader
    title={headerTitle ?? "Regular Runs"}
    subtitle={headerSubtitle ??
      "We meet outside the Beijing Restaurant in Horsell for three weekly sessions. Each run is social, welcoming, and designed to suit different paces."}
  />

  <section class="section">
    <div class="container grid grid-2">
      {runCards.map((run) => (
        <article id={run.id} class="card">
          <div>
            <h2>{run.data.name}</h2>
            <p class="meta">{run.data.schedule} Â· {run.data.time}</p>
          </div>
          {run.hasBody && (
            <div class="run-copy">
              <run.Content />
            </div>
          )}
          <div class="grid" style="gap: 0.5rem;">
            <p><strong>Distance:</strong> {run.data.distance}</p>
            <p><strong>Pace:</strong> {run.data.pace}</p>
            <p><strong>Meeting point:</strong> {run.data.meetingPoint}</p>
            <p><strong>What to bring:</strong> {run.data.whatToBring}</p>
            <p><strong>Who it is for:</strong> {run.data.whoFor}</p>
          </div>
        </article>
      ))}
    </div>
  </section>

  {ctaSection && (
    <section class="section">
      <div class="container">
        <div class="card">
          <h3>{ctaSection.data.title}</h3>
          {ctaSection.hasBody && (
            <div class="run-copy">
              <ctaSection.Content />
            </div>
          )}
          <div class="btn-row">
            <a class="btn btn-primary" href={ctaSection.data.primaryHref}>
              {ctaSection.data.primaryLabel}
            </a>
            <a class="btn btn-outline" href={ctaSection.data.secondaryHref}>
              {ctaSection.data.secondaryLabel}
            </a>
          </div>
        </div>
      </div>
    </section>
  )}
</BaseLayout>

<style>
  .run-copy :global(p) {
    margin: 0;
    color: var(--color-muted);
  }
</style>
