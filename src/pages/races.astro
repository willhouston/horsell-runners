---
import BaseLayout from "../layouts/BaseLayout.astro";
import PageHeader from "../components/PageHeader.astro";
import { getCollection, getEntry } from "astro:content";
import { Image } from "astro:assets";

const racesPage = await getEntry("pages", "races");

if (!racesPage) {
  throw new Error("Missing content entry: src/content/pages/races.md");
}

const { title, description, headerTitle, headerSubtitle } = racesPage.data;
const raceEntries = (await getCollection("races")).sort(
  (a, b) => a.data.order - b.data.order
);
const upcomingRaces = raceEntries.filter((race) => race.data.group === "upcoming");
const pastRaces = raceEntries.filter((race) => race.data.group === "past");

const formatDate = (date: Date) =>
  new Date(date).toLocaleDateString("en-GB", {
    day: "numeric",
    month: "long",
    year: "numeric",
  });
---
<BaseLayout title={title} description={description}>
  <PageHeader
    title={headerTitle ?? "Club Races"}
    subtitle={headerSubtitle ??
      "We pick a few key races each season and train together. Join us for the long runs, the cheer squad, and the post-race stories."}
  />

  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="section-eyebrow">Upcoming</span>
        <h2 class="section-title">Upcoming races</h2>
        <p class="section-subtitle">Register early so we can organise pace groups.</p>
      </div>
      <div class="grid grid-3">
        {upcomingRaces.map((race) => (
          <article class="card">
            {race.data.logo && (
              <Image
                src={race.data.logo}
                alt={`${race.data.name} logo`}
                width={800}
                format="webp"
                class="embed race-logo"
              />
            )}
            <h3>{race.data.name}</h3>
            <p class="meta">{formatDate(race.data.date)} · {race.data.distance}</p>
            <p>{race.data.location}</p>
            {race.data.signupUrl && (
              <a class="btn btn-outline" href={race.data.signupUrl} target="_blank" rel="noreferrer">
                Info
              </a>
            )}
          </article>
        ))}
      </div>
    </div>
  </section>

  <section class="section">
    <div class="container">
      <div class="section-header">
        <span class="section-eyebrow">Past Races</span>
        <h2 class="section-title">Recent highlights</h2>
        <p class="section-subtitle">
          We celebrate every finish line, from personal bests to first-time medals.
        </p>
      </div>
      <div class="grid grid-3">
        {pastRaces.map((race) => (
          <article class="card">
            {race.data.logo && (
              <Image
                src={race.data.logo}
                alt={`${race.data.name} logo`}
                width={800}
                format="webp"
                class="embed race-logo"
              />
            )}
            <h3>{race.data.name}</h3>
            <p class="meta">{formatDate(race.data.date)} · {race.data.distance}</p>
            <p>{race.data.location}</p>
          </article>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>

<style>
  .race-logo {
    width: 100%;
    height: auto;
    object-fit: contain;
  }
</style>
